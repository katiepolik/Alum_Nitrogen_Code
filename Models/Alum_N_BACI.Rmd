---
title: "Alum_N_BACI"
output: html_document
date: "2024-11-19"
---

```{r setup, include=FALSE}
library(knitr) #for knitting! and tables
library(tidyverse)
#remotes::install_github("mnsentinellakes/mnsentinellakes") #need to install mnsentinellakes from github
library(mnsentinellakes) #fixing lake IDs
library(lubridate) #for dates
library(ggplot2) #for plotting
library(here) #for reading in data

library(lme4) #for lmms
library(lmerTest) #hypothesis testing lmms
library(emmeans) #post-hoc tests for lme4
library(broom.mixed) #for outputting model coefficients

knitr::opts_chunk$set(echo = TRUE)
select <- dplyr::select #if you happen to have MASS loaded you need to reassign the select function
```

## Alum Lakes

The following is a list of alum treatments used in this analysis. A comma between dates indicates that the treatments are analyzed as separate events; a slash indicates they are analyzed as one event.


```{r Alum Lakes}
#load in alum treated lakes
LakeList <- read.csv(here("Data/Alum_Lakes_Table.csv")) %>%
  mutate(DOW = fixlakeid(DOW))%>%
  arrange(Year)

kable(LakeList %>% select (Name, Depth.Cat, Year))
```

Data Set Up

Only data from June 1 - Sept 15 are included.

Treatments that happen with at least 4 summers in between alum applications are analyzed separately. Treatments with 3 or fewer summers in between are analyzed as one treatment, omitting the data in between the two applications. In these cases, the pre-treatment window ends when the first dose was applied and the post-treatment window begins when the second dose was applied.


```{r, echo = FALSE}
#import time series data
Timeseries <- read.csv(here("Data/Timeseries_v6_forEDI.csv")) %>%
  mutate(DOW = fixlakeid(DOW),
         sampleDate = as.Date(sampleDate),
         sampleYear = year(sampleDate),
         Julian = yday(sampleDate),
         day = day(sampleDate)) %>%
  filter(Julian >= 152 & Julian <= 259) %>% #Jun 1 to Sept 15 window with extra days on leap years
  filter(!(Julian == 152 & day == 31)) %>% #remove May 31st from leap years
  filter(!(Julian == 259 & day == 16)) %>% #remove Sept 16 from non-leap years
  select(-day, -Julian)
```

```{r, echo = FALSE}
#load in alum dose dates
DoseDates <- read.csv(here("Data/Alum_Dose_Dates.csv")) %>%
  mutate(DOW = fixlakeid(DOW),
         Pre.Lower = mdy(Pre.Lower), 
         Pre.Upper = mdy(Pre.Upper), 
         Post.Lower = mdy(Post.Lower), 
         Post.Upper = mdy(Post.Upper))

parameters <- c("TP.mg_L", "TN.mg_L", "TKN.mg_L", "secchi.m", "chla.Pcorr.ug_L", "chla.nonPcorr.ug_L", "NOX.mg_L", "NH4.mg_L")

AlumTimeseries_long <- Timeseries %>%
  filter(DOW %in% DoseDates$DOW) %>%
  filter(parameter %in% parameters) 

#subset data needed for analysis and add treatment metadata

AlumList = list()

for(i in 1:dim(DoseDates)[1]) {
  Alum_subset <- AlumTimeseries_long %>%
    filter(DOW == DoseDates$DOW[i]) %>%
    mutate(treatment = case_when(sampleYear == DoseDates$Pre.One[i] | 
                                   sampleYear == DoseDates$Pre.Two[i] ~ "pre",
                                 sampleYear == DoseDates$Post.One[i] | 
                                   sampleYear == DoseDates$Post.Two[i] ~ "post"),
           postLong = case_when(sampleDate >= DoseDates$Post.Lower[i] & 
                                   sampleYear < DoseDates$Additional.Stop[i] ~ 1,
                                TRUE ~ 0),
           preLong = case_when(sampleDate <= DoseDates$Pre.Upper[i] & 
                                   sampleYear >= DoseDates$Back.Stop[i] ~ 1,
                                TRUE ~ 0),
           postYear = sampleYear - year(DoseDates$Post.Lower[i]) + 1,
           preYear = sampleYear - DoseDates$Back.Stop[i] + 1,
           evertreat = 1,
           DOWApp = paste(DoseDates$DOW[i], DoseDates$Application[i], sep="")) %>%
    filter(!is.na(treatment) | postLong == 1 | preLong == 1) %>%
    filter(case_when(DoseDates$N.Type[i] == "TN.mg_L" ~ parameter != "TKN.mg_L",
                     DoseDates$N.Type[i] == "TKN.mg_L" ~ parameter != "TN.mg_L",
                     DoseDates$N.Type[i] == "Both" ~ parameter != "Both",
                     is.na(DoseDates$N.Type[i]) ~ parameter != "TKN.mg_L" & parameter != "TN.mg_L" & parameter != "NOX.mg_L"))
    
  AlumList[[i]] <- Alum_subset # add subset to list

}

AlumData_long = do.call(rbind, AlumList) %>% #make some changes for specific data or treatment date issues
  filter(!(DOW == "27004800" & (parameter == "chla.Pcorr.ug_L" | parameter == "chla.nonPcorr.ug_L"))) %>% #remove chla from this lake 
  filter(!(DOW == "10000200" & (sampleDate == "2020-06-03" | sampleDate == "2020-06-18"))) #alum treatment happened on 20-Jun-2020

#Make the data wide for analysis
#There are a small number of sampling events that have both TKN and TN data from 27001600 and 27003100. I'll use the TN data for these points

AlumData <- AlumData_long %>%
  select(-dataSource, -county) %>%
  pivot_wider(names_from = parameter,
              values_from = c(result, gtlt)) %>%
  rename_with(~str_replace(., 'result_', '')) %>%
  mutate(gtlt_TKN.mg_L = case_when(!is.na(TKN.mg_L) & !is.na(TN.mg_L) ~ NA,
                                TRUE ~ gtlt_TKN.mg_L),
         TKN.mg_L = case_when(!is.na(TKN.mg_L) & !is.na(TN.mg_L) ~ NA,
                                TRUE ~ TKN.mg_L))


#There are some duplicated sampling events in this dataset when the "pre" window of treatment "b" overlaps with the long post window of an "a" treatment. These duplicated sampling events are not used in the same analysis, and separating pre-post analysis data from the long-term analysis data (done later) fixes this

```

QAQC
Let's check how we're doing for data completeness for TP, TN, secchi, and chla

```{r}
#TP Test for years with a low # of measurements
AlumData %>%
  filter(!is.na(treatment) & !is.na(TP.mg_L)) %>%
  select(sampleYear, DOWApp, treatment) %>%
  group_by(DOWApp, sampleYear) %>%
  summarise(pre = sum(treatment == "pre"), post = sum(treatment == "post")) %>%
  filter((pre < 4 & pre > 0) | (post < 4 & post > 0))

#10008400 only has one sample (chem and secchi) for 2009 (pre year #1), no other usable years
#19002500 in 2021 only has 2 TP dates (same as 2020, the other usable post year) but slightly better secchi data than 2020
#Everything else has at least 4 data points

#TP Test for missing years
AlumData %>%
  filter(!is.na(treatment) & !is.na(TP.mg_L)) %>%
  select(sampleYear, DOWApp, treatment) %>%
  distinct() %>%
  group_by(DOWApp) %>%
  summarise(pre = sum(treatment == "pre"), post = sum(treatment == "post")) %>%
  filter(pre < 2 | post < 2)

# -------------------------------------

#Secchi Test for years with a low # of measurements
AlumData %>%
  filter(!is.na(treatment) & !is.na(secchi.m)) %>%
  select(sampleYear, DOWApp, treatment) %>%
  group_by(DOWApp, sampleYear) %>%
  summarise(pre = sum(treatment == "pre"), post = sum(treatment == "post")) %>%
  filter((pre < 4 & pre > 0) | (post < 4 & post > 0))

#Secchi Test
AlumData %>%
  filter(!is.na(treatment) & !is.na(secchi.m)) %>%
  select(sampleYear, DOWApp, treatment) %>%
  distinct() %>%
  group_by(DOWApp) %>%
  summarise(pre = sum(treatment == "pre"), post = sum(treatment == "post")) %>%
  filter(pre < 2 | post < 2)

#27104501 has no secchi data in 2019, but 2020 has almost no chem data, and I'd rather be missing a year of secchi data than chem

# -------------------------------------

#Nitrogen Test for years with a low # of measurements
AlumData %>%
  filter(!is.na(treatment)) %>% 
  filter(!is.na(TKN.mg_L) | !is.na(TN.mg_L)) %>%
  select(sampleYear, DOWApp, treatment) %>%
  group_by(DOWApp, sampleYear) %>%
  summarise(pre = sum(treatment == "pre"), post = sum(treatment == "post")) %>%
  filter((pre < 4 & pre > 0) | (post < 4 & post > 0))

#Nitrogen Test
AlumData %>%
  filter(!is.na(treatment)) %>% 
  filter(!is.na(TKN.mg_L) | !is.na(TN.mg_L)) %>%
  select(sampleYear, DOWApp, treatment) %>%
  distinct() %>%
  group_by(DOWApp) %>%
  summarise(pre = sum(treatment == "pre"), post = sum(treatment == "post")) %>%
  filter(pre < 2 | post < 2)

# -------------------------------------

#Chla Test for years with a low # of measurements
AlumData %>%
  filter(!is.na(treatment)) %>% 
  filter(!is.na(chla.Pcorr.ug_L) | !is.na(chla.nonPcorr.ug_L)) %>%
  select(sampleYear, DOWApp, treatment) %>%
  group_by(DOWApp, sampleYear) %>%
  summarise(pre = sum(treatment == "pre"), post = sum(treatment == "post")) %>%
  filter((pre < 4 & pre > 0) | (post < 4 & post > 0))

#Chla Test
AlumData %>%
  filter(!is.na(treatment)) %>% 
  filter(!is.na(chla.Pcorr.ug_L) | !is.na(chla.nonPcorr.ug_L)) %>%
  select(sampleYear, DOWApp, treatment) %>%
  distinct() %>%
  group_by(DOWApp) %>%
  summarise(pre = sum(treatment == "pre"), post = sum(treatment == "post")) %>%
  filter(pre < 2 | post < 2)

```
A summary of the above small data problems:
10008400 only has one sample (chem and secchi) for 2009 (pre year #1), no other usable years
19002500 in 2021 only has 2 TP, 3 TKN, and 3 chla (same as 2020, the other usable post-alum year) but slightly better secchi data than 2020
27104501 has no secchi data in 2019, but 2020 has almost no chem data, and I'd rather be missing a year of secchi data than chem
27004800 is missing chla data for 2020 and only has late season points for 2019 so this would skew post-chla really high
        as opposed to pushing post dates to 2021 and 2022 I'm just going to exclude this lake from the chla analysis, which I've gone back up in the code and done earlier
        
Otherwise, all other treatments/years should have 4 data points at least. This is not necessarily true for the postLong data

------------------------------------------------------------------
Now let's go through and do this for all the control lakes for the BACI analysis


```{r, echo = FALSE}
#load in control dose dates
ControlDates <- read.csv(here("Data/Alum_Simulation_Dates.csv")) %>%
  mutate(DOW = fixlakeid(DOW),
         Pre.Lower = mdy(Pre.Lower), 
         Pre.Upper = mdy(Pre.Upper), 
         Post.Lower = mdy(Post.Lower), 
         Post.Upper = mdy(Post.Upper))

parameters <- c("TP.mg_L", "TN.mg_L", "TKN.mg_L", "secchi.m", "chla.Pcorr.ug_L", "chla.nonPcorr.ug_L", "NOX.mg_L", "NH4.mg_L")

ControlTimeseries_long <- Timeseries %>%
  filter(DOW %in% ControlDates$DOW) %>%
  filter(parameter %in% parameters) 

#subset data needed for analysis and add treatment metadata

ControlList = list()

for(i in 1:dim(ControlDates)[1]) {
  Control_subset <- ControlTimeseries_long %>%
    filter(DOW == ControlDates$DOW[i]) %>%
    mutate(treatment = case_when(sampleYear == ControlDates$Pre.One[i] | 
                                   sampleYear == ControlDates$Pre.Two[i] ~ "pre",
                                 sampleYear == ControlDates$Post.One[i] | 
                                   sampleYear == ControlDates$Post.Two[i] ~ "post"),
           evertreat = 0,
           preLong = 0,
           postLong = 0,
           preYear = 0,
           postYear = 0,
           DOWApp = paste(ControlDates$DOW[i], ControlDates$Application[i], sep="")) %>%
    filter(!is.na(treatment)) %>%
    filter(case_when(ControlDates$N.Type[i] == "TN.mg_L" ~ parameter != "TKN.mg_L",
                     ControlDates$N.Type[i] == "TKN.mg_L" ~ parameter != "TN.mg_L"))
    
  ControlList[[i]] <- Control_subset # add subset to list

}

ControlData_long = do.call(rbind, ControlList) %>%
  filter(!(parameter == "TP.mg_L" & result == 0)) #remove TP = 0 data point

ControlData <- ControlData_long %>%
  select(-dataSource, -county) %>%
  pivot_wider(names_from = parameter,
              values_from = c(result, gtlt)) %>%
  rename_with(~str_replace(., 'result_', '')) 


```


QAQC
Let's check how we're doing for data completeness for TP, TN, secchi, and chla

```{r, echo= F}
#TP Test for years with a low # of measurements
ControlData %>%
  filter(!is.na(treatment) & !is.na(TP.mg_L)) %>%
  select(sampleYear, DOWApp, treatment) %>%
  group_by(DOWApp, sampleYear) %>%
  summarise(pre = sum(treatment == "pre"), post = sum(treatment == "post")) %>%
  filter((pre < 4 & pre > 0) | (post < 4 & post > 0))


#TP Test for missing years
ControlData %>%
  filter(!is.na(treatment) & !is.na(TP.mg_L)) %>%
  select(sampleYear, DOWApp, treatment) %>%
  distinct() %>%
  group_by(DOWApp) %>%
  summarise(pre = sum(treatment == "pre"), post = sum(treatment == "post")) %>%
  filter(pre < 2 | post < 2)

# -------------------------------------

#Secchi Test for years with a low # of measurements
ControlData %>%
  filter(!is.na(treatment) & !is.na(secchi.m)) %>%
  select(sampleYear, DOWApp, treatment) %>%
  group_by(DOWApp, sampleYear) %>%
  summarise(pre = sum(treatment == "pre"), post = sum(treatment == "post")) %>%
  filter((pre < 4 & pre > 0) | (post < 4 & post > 0))

#Secchi Test
ControlData %>%
  filter(!is.na(treatment) & !is.na(secchi.m)) %>%
  select(sampleYear, DOWApp, treatment) %>%
  distinct() %>%
  group_by(DOWApp) %>%
  summarise(pre = sum(treatment == "pre"), post = sum(treatment == "post")) %>%
  filter(pre < 2 | post < 2)


# -------------------------------------

#Nitrogen Test for years with a low # of measurements
ControlData %>%
  filter(!is.na(treatment)) %>% 
  filter(!is.na(TKN.mg_L) | !is.na(TN.mg_L)) %>%
  select(sampleYear, DOWApp, treatment) %>%
  group_by(DOWApp, sampleYear) %>%
  summarise(pre = sum(treatment == "pre"), post = sum(treatment == "post")) %>%
  filter((pre < 4 & pre > 0) | (post < 4 & post > 0))

#Nitrogen Test
ControlData %>%
  filter(!is.na(treatment)) %>% 
  filter(!is.na(TKN.mg_L) | !is.na(TN.mg_L)) %>%
  select(sampleYear, DOWApp, treatment) %>%
  distinct() %>%
  group_by(DOWApp) %>%
  summarise(pre = sum(treatment == "pre"), post = sum(treatment == "post")) %>%
  filter(pre < 2 | post < 2)

# -------------------------------------

#Chla Test for years with a low # of measurements
ControlData %>%
  filter(!is.na(treatment)) %>% 
  filter(!is.na(chla.Pcorr.ug_L) | !is.na(chla.nonPcorr.ug_L)) %>%
  select(sampleYear, DOWApp, treatment) %>%
  group_by(DOWApp, sampleYear) %>%
  summarise(pre = sum(treatment == "pre"), post = sum(treatment == "post")) %>%
  filter((pre < 4 & pre > 0) | (post < 4 & post > 0))

#Chla Test
ControlData %>%
  filter(!is.na(treatment)) %>% 
  filter(!is.na(chla.Pcorr.ug_L) | !is.na(chla.nonPcorr.ug_L)) %>%
  select(sampleYear, DOWApp, treatment) %>%
  distinct() %>%
  group_by(DOWApp) %>%
  summarise(pre = sum(treatment == "pre"), post = sum(treatment == "post")) %>%
  filter(pre < 2 | post < 2)




```

Monitoring isn't as extensive on lakes that aren't being alum treated and so I'm trying to use a cut off of 3 samples per year here
All treatments/years have at least 3 data points! This is not necessarily true for the postLong data

---------------------------------------------

Time for a little more data manipulation! Let's join these two data frames, clean up N and chla data, calculate some log values, and calculate some ratios

```{r}
AllData <- rbind(AlumData, ControlData) %>%
  mutate(N.mg_L = case_when(!is.na(TN.mg_L) ~ TN.mg_L, #Merge TN and TKN into one column
                            is.na(TN.mg_L) & !is.na(TKN.mg_L) ~ TKN.mg_L,
                            is.na(TN.mg_L) & is.na(TKN.mg_L) ~ NA),
         Ntype = case_when(!is.na(TN.mg_L) ~ "TN.mg_L",
                            is.na(TN.mg_L) & !is.na(TKN.mg_L) ~ "TKN.mg_L",
                            is.na(TN.mg_L) & is.na(TKN.mg_L) ~ NA),
         gtlt_N.mg_L = case_when(!is.na(TN.mg_L) ~ gtlt_TN.mg_L,
                            is.na(TN.mg_L) & !is.na(TKN.mg_L) ~ gtlt_TKN.mg_L,
                            is.na(TN.mg_L) & is.na(TKN.mg_L) ~ NA)) %>%
  select(-TN.mg_L, -TKN.mg_L, -gtlt_TN.mg_L, -gtlt_TKN.mg_L) %>%
  
  mutate(chla.ug_L = case_when(!is.na(chla.Pcorr.ug_L) ~ chla.Pcorr.ug_L, #use pheophytin corrected chla when available
                            is.na(chla.Pcorr.ug_L) & !is.na(chla.nonPcorr.ug_L) ~ chla.nonPcorr.ug_L,
                            is.na(chla.Pcorr.ug_L) & is.na(chla.nonPcorr.ug_L) ~ NA),
         pheo.corr = case_when(!is.na(chla.Pcorr.ug_L) ~ 1,
                            is.na(chla.Pcorr.ug_L) & !is.na(chla.nonPcorr.ug_L) ~ 0,
                            is.na(chla.Pcorr.ug_L) & is.na(chla.nonPcorr.ug_L) ~ NA),
         gtlt_chla.ug_L = case_when(!is.na(chla.Pcorr.ug_L) ~ gtlt_chla.Pcorr.ug_L,
                            is.na(chla.Pcorr.ug_L) & !is.na(chla.nonPcorr.ug_L) ~ gtlt_chla.nonPcorr.ug_L,
                            is.na(chla.Pcorr.ug_L) & is.na(chla.nonPcorr.ug_L) ~ NA)) %>%
  select(-chla.Pcorr.ug_L, -chla.nonPcorr.ug_L, -gtlt_chla.Pcorr.ug_L, -gtlt_chla.nonPcorr.ug_L ) %>%
  
  mutate(secchi.m = case_when(secchi.m == 0 ~ NA,   #remove 0s in secchi dataset
                              secchi.m != 0 ~ secchi.m)) %>%
  
  mutate(TP.log = log(TP.mg_L),
         N.log = log(N.mg_L),
         chla.log = log(chla.ug_L),
         NP.ratio = (N.mg_L / TP.mg_L) * (30.974/14.007), #molar TN:TP ratio
         NP.log = log(NP.ratio)) %>%
  mutate(treatment = factor(treatment, levels = c("pre", "post")))


#separate data into two separate dataframes for the shortterm and longterm analyses

PrePostData <- AllData %>%
  filter(!is.na(treatment))
  
LongData <- AllData %>%
  filter(postLong == 1 | preLong == 1) 

```


Calculate how much of the dataset is flagged as below detection

```{r}
BDL <- AllData %>%
  select(-treatment, -postLong, -postYear, -evertreat, -DOWApp, -preYear, -preLong)
BDL.dedup <- BDL[!duplicated(BDL),]  #deduplicates to account for data that shows up in both short-term and long-term analyses

TP.BDL <- BDL.dedup %>%
  filter(!is.na(TP.mg_L)) %>%
  summarise(BDL = sum(gtlt_TP.mg_L > 0), total = n())

TN.BDL <- BDL.dedup %>%
  filter(!is.na(N.mg_L)) %>%
  summarise(BDL = sum(gtlt_N.mg_L > 0), total = n())

Chla.BDL <- BDL.dedup %>%
  filter(!is.na(chla.ug_L)) %>%
  summarise(BDL = sum(gtlt_chla.ug_L > 0), total = n())

  
```

---------------------------------------------------------
NOX
Let's look at short term pre/post

```{r}
NOX <- PrePostData %>% 
  filter(!is.na(NOX.mg_L)) %>%
  mutate(NOX.frac = NOX.mg_L/N.mg_L)

NH4 <- PrePostData %>% 
  filter(!is.na(NH4.mg_L)) %>%
  mutate(NH4.frac = NH4.mg_L/N.mg_L)

#how many treatments have NOX data
NOX.treat <- NOX %>% filter(evertreat == 1) %>% group_by(DOWApp, treatment) %>% summarise(n = n())

#what detection limits are actually reported
DL <- NOX %>% filter(gtlt_NOX.mg_L > 0) %>% group_by(NOX.mg_L) %>% summarise(n = n())

#how many data points are marked as BDL
NOX %>% group_by(evertreat, treatment) %>% summarise(BDL = sum(gtlt_NOX.mg_L > 0), total = n())
NH4 %>% group_by(evertreat, treatment) %>% summarise(BDL = sum(gtlt_NH4.mg_L > 0), total = n())

#how much is < 0.03, the most common detection limit
NOX %>% group_by(evertreat, treatment) %>% summarise(BDL = sum(NOX.mg_L <= 0.03 | gtlt_NOX.mg_L > 0), total = n())
NH4 %>% group_by(evertreat, treatment) %>% summarise(BDL = sum(NH4.mg_L <= 0.04 | gtlt_NH4.mg_L > 0), total = n())

#Essentially, there's no evidence for widespread increases in NOX standing pools like in deeper, oligotrophic systems 

```

----------------------------------
SHORT-TERM ANALYSIS

```{r}
PrePostData <- PrePostData %>%
  mutate(evertreat2 = case_when(evertreat == 0 ~ 1,
                                evertreat == 1 ~ 0)) #re-coding the evertreat parameter to increase interpretability

```

TP BACI
```{r, echo=FALSE, fig.height=3, fig.width=2.5}

TP_BACI_model <- lmer(data = PrePostData %>% filter(!is.na(TP.mg_L)), 
                      log(TP.mg_L) ~ treatment*evertreat2 + (1|DOWApp))
tidy(TP_BACI_model)

TP.emm <- confint(emmeans(TP_BACI_model, ~ evertreat2*treatment, type = 'response'))

dodge <- position_dodge(width=0.25)
ggplot(TP.emm, aes(x=factor(treatment), y=response, 
                   color=factor(evertreat2), 
                   group = factor(evertreat2),
                   shape = factor(evertreat2))) + 
  geom_line(show.legend = F, position = dodge, linetype = "dotted") +
  geom_point(position = dodge, show.legend = F, size = 2.5) +
  scale_shape_manual(values=c(15,19))+
  geom_errorbar(aes(ymax=upper.CL,ymin=lower.CL),position = dodge, show.legend = F, width  = 0.25) + 
  scale_colour_manual(values=c("black","grey45")) +
  #scale_colour_manual(values=c("#DC3220", "#005AB5")) +
  theme_classic() +
  ylab("Total Phosphorus (mg/L)") +
  xlab("") +
  expand_limits(y = 0) +
  scale_y_continuous(expand = c(0,0), limits = c(0,0.07)) +
  scale_x_discrete(labels=c('Before', 'After'))

ggsave("TP_BACI.pdf", path = here("Plots"))

```

TN BACI
```{r, echo=FALSE, fig.height=3, fig.width=2.5}

N_BACI_model <- lmer(data = PrePostData %>% filter(!is.na(N.mg_L)), 
                      log(N.mg_L) ~ treatment*evertreat2 + (1|DOWApp))
tidy(N_BACI_model)

N.emm <- confint(emmeans(N_BACI_model, ~ evertreat2*treatment, type = 'response'))

dodge <- position_dodge(width=0.25)
ggplot(N.emm, aes(x=factor(treatment), y=response, 
                  color=factor(evertreat2), 
                  group = factor(evertreat2),
                  shape = factor(evertreat2))) + 
  geom_line(show.legend = F, position = dodge, linetype = "dotted") +
  geom_point(position = dodge, show.legend = F, size = 2.5) +
  scale_shape_manual(values=c(15,19))+
  geom_errorbar(aes(ymax=upper.CL,ymin=lower.CL),position = dodge, show.legend = F, width  = 0.25) + 
  scale_colour_manual(values=c("black", "grey45")) +
  #scale_colour_manual(values=c("#DC3220", "#005AB5")) +
  theme_classic() +
  ylab("Total Nitrogen (mg/L)") +
  xlab("") +
  expand_limits(y = 0) +
  scale_y_continuous(expand = c(0,0), limits = c(0,1.5)) +
  scale_x_discrete(labels=c('Before', 'After'))

ggsave("TN_BACI.pdf", path = here("Plots"))

```


chla BACI
```{r, echo=FALSE, fig.height=3, fig.width=2.5}

CHLA_BACI_model <- lmer(data = PrePostData %>% filter(!is.na(chla.ug_L)), 
                      log(chla.ug_L) ~ treatment*evertreat2 + (1|DOWApp))
tidy(CHLA_BACI_model)

chla.emm <- confint(emmeans(CHLA_BACI_model, ~ evertreat2*treatment, type = 'response'))

dodge <- position_dodge(width=0.25)
my_y_title <- expression(paste("Chlorophyll ", italic("a"), " (ug/L)"))
ggplot(chla.emm, aes(x=factor(treatment), y=response, 
                     color=factor(evertreat2), 
                     group = factor(evertreat2),
                     shape = factor(evertreat2))) + 
  geom_line(show.legend = F, position = dodge, linetype = "dotted") +
  geom_point(position = dodge, show.legend = F, size = 2.5) +
  scale_shape_manual(values=c(15,19))+
  geom_errorbar(aes(ymax=upper.CL,ymin=lower.CL),position = dodge, show.legend = F, width  = 0.25) + 
  scale_colour_manual(values=c("black", "grey45")) +
  #scale_colour_manual(values=c("#DC3220", "#005AB5")) +
  theme_classic() +
  ylab(my_y_title) +
  xlab("") +
  expand_limits(y = 0) +
  scale_y_continuous(expand = c(0,0), limits = c(0,25)) +
  scale_x_discrete(labels=c('Before', 'After'))

ggsave("CHLA_BACI.pdf", path = here("Plots"))

```

Secchi BACI
```{r, echo=FALSE, fig.height=3, fig.width=2.5}

Secchi_BACI_model <- lmer(data = PrePostData %>% filter(!is.na(secchi.m)), 
                      secchi.m ~ treatment*evertreat2 + (1|DOWApp))
tidy(Secchi_BACI_model)

secchi.emm <- confint(emmeans(Secchi_BACI_model, ~ evertreat2*treatment))

dodge <- position_dodge(width=0.25)
ggplot(secchi.emm, aes(x=factor(treatment), y=emmean, 
                       color=factor(evertreat2), 
                       group = factor(evertreat2),
                       shape = factor(evertreat2))) + 
  geom_line(show.legend = F, position = dodge, linetype = "dotted") +
  geom_point(position = dodge, show.legend = F, size = 2.5) +
  scale_shape_manual(values=c(15,19))+
  geom_errorbar(aes(ymax=upper.CL,ymin=lower.CL),position = dodge, show.legend = F, width  = 0.25) + 
  scale_colour_manual(values=c("black", "grey45")) +
  #scale_colour_manual(values=c("#DC3220", "#005AB5")) +
  theme_classic() +
  ylab("Secchi Depth (m)") +
  xlab("")+
  expand_limits(y = 0) +
  scale_y_continuous(expand = c(0,0), limits = c(0,3)) +
  scale_x_discrete(labels=c('Before', 'After'))

ggsave("Secchi_BACI.pdf", path = here("Plots"))
  

```

NP BACI
```{r, echo=FALSE, fig.height=3, fig.width=2.5}

NP_BACI_model <- lmer(data = PrePostData %>% filter(!is.na(NP.ratio)), 
                      log(NP.ratio) ~ treatment*evertreat2 + (1|DOWApp))
tidy(NP_BACI_model)

np.emm <- confint(emmeans(NP_BACI_model, ~ evertreat2*treatment, type = 'response'))

dodge <- position_dodge(width=0.25)
ggplot(np.emm, aes(x=factor(treatment), y=response, 
                   color=factor(evertreat2), 
                   group = factor(evertreat2),
                   shape = factor(evertreat2))) + 
  geom_line(show.legend = F, position = dodge, linetype = "dotted") +
  geom_point(position = dodge, show.legend = F, size = 2.5) +
  scale_shape_manual(values=c(15,19))+
  geom_errorbar(aes(ymax=upper.CL,ymin=lower.CL),position = dodge, show.legend = F, width  = 0.25) + 
  scale_colour_manual(values=c("black", "grey45")) +
  #scale_colour_manual(values=c("#DC3220", "#005AB5")) +
  theme_classic() +
  ylab("TN:TP") +
  xlab("") +
  expand_limits(y = 0) +
  scale_y_continuous(expand = c(0,0), limits = c(25,70))+
  scale_x_discrete(labels=c('Before', 'After'))

ggsave("NP_BACI.pdf", path = here("Plots"))

```

-------------------------------------------
LONG-TERM ANALYSIS

Is there a trend in these parameters after alum treatment? (sustained reduction? rebound?)
Does the trend change from the trend leading into the alum treatment?

Lake selection:
How many years of data do we have for each DOWApp?
I'm going to keep lakes with 4 or more years of data in the before-treatment period and 4 or more years of data in the after-treatment period.
For the most part I'm only going to include first treatments if there are multiple treatments on a lake unless there is a large gap in time between treatments. The after-treatment window will end when the second treatment occurs, even if 8 years haven't elapsed.


Comparing pre-treatment and post-treatment trends for alum treated lakes

```{r}

DOWLengthPost <- LongData %>%
  filter(postLong == 1) %>%
  select(DOWApp, postYear) %>%
  distinct() %>%
  group_by(DOWApp) %>%
  summarise(n = n()) %>%
  filter(n > 3) %>%
  select(DOWApp)

DOWLengthPre <- LongData %>%
  filter(preLong == 1) %>%
  select(DOWApp, preYear) %>%
  distinct() %>%
  group_by(DOWApp) %>%
  summarise(n = n()) %>%
  filter(n > 3) %>%
  select(DOWApp)

DOWLength <- inner_join(DOWLengthPost, DOWLengthPre) #selects treatments that have 4 years of data pre and post
  
LongData2 <- LongData %>%
  filter(DOWApp %in% DOWLength$DOWApp) %>%
  mutate(modYear = case_when(preLong == 1 ~ preYear,
                             postLong == 1 ~ postYear)) %>%
  mutate(plotYear = case_when(preLong == 1 ~ preYear - 9,
                             postLong == 1 ~ postYear))

```

```{r, fig.width = 4, fig.height=3}
P_lt_model2 <- lmer(data = LongData2 %>% filter(!is.na(TP.mg_L)), 
                      log(TP.mg_L) ~ modYear*preLong + (1|DOWApp))
tidy(P_lt_model2)

N_lt_model2 <- lmer(data = LongData2 %>% filter(!is.na(N.mg_L)), 
                      log(N.mg_L) ~ modYear*preLong + (1|DOWApp))
tidy(N_lt_model2)

Secchi_lt_model2 <- lmer(data = LongData2 %>% filter(!is.na(secchi.m)), 
                      secchi.m ~ modYear*preLong + (1|DOWApp))
tidy(Secchi_lt_model2)

Chla_lt_model2 <- lmer(data = LongData2 %>% filter(!is.na(chla.ug_L)), 
                      log(chla.ug_L) ~ modYear*preLong + (1|DOWApp))
tidy(Chla_lt_model2)

NP_lt_model2 <- lmer(data = LongData2 %>% filter(!is.na(NP.ratio)), 
                      log(NP.ratio) ~ modYear*preLong + (1|DOWApp))
tidy(NP_lt_model2)

#inspect these for significant slopes for pre and post
emt.TP <- test(emtrends(P_lt_model2, "preLong", var = "modYear"))
emt.TN <- test(emtrends(N_lt_model2, "preLong", var = "modYear"))
emt.NP <- test(emtrends(NP_lt_model2, "preLong", var = "modYear"))
emt.chla <- test(emtrends(Chla_lt_model2, "preLong", var = "modYear"))
emt.Secchi <- test(emtrends(Secchi_lt_model2, "preLong", var = "modYear"))

```

```{r, fig.width = 3.5, fig.height=3}

newdat3 <- data.frame(modYear = c(seq(1, 8, 1), seq(1, 8, 1)),
                     preLong = c(1,1,1,1,1,1,1,1,0,0,0,0,0,0,0,0),
                     plotYear = c(seq(-8, -1, 1), seq(1, 8, 1)))

newdat3$TP <- exp(predict(P_lt_model2, newdata = newdat3, re.form = NA))
newdat3$TN <- exp(predict(N_lt_model2, newdata = newdat3, re.form = NA))
newdat3$NP <- exp(predict(NP_lt_model2, newdata = newdat3, re.form = NA))
newdat3$Secchi <- predict(Secchi_lt_model2, newdata = newdat3, re.form = NA)
newdat3$chla <- exp(predict(Chla_lt_model2, newdata = newdat3, re.form = NA))


ggplot() + 
  scale_y_log10() +
  theme_classic() +
  geom_boxplot(width = 0.7, show.legend = F, data = LongData2 %>% filter(!is.na(N.mg_L)), 
               aes(x=factor(plotYear), y=N.mg_L, fill=factor(preLong)),
               outlier.size=0.5, lwd = 0.5) +
  scale_fill_manual(values=c("grey", "white")) +
  geom_line(data = newdat3, 
            aes(group = preLong, x = as.factor(plotYear), y = TN, 
                colour = as.factor(preLong)),
            show.legend = F,
            lwd = 1.2) +
  scale_color_manual(values=c(I("black"), I("#005AB5"))) +
  ylab("Total Nitrogen (mg/L)") +
  xlab("Years Relative to Alum Treatment") 

ggsave("LT_TN.pdf", path = here("Plots"))


ggplot() + 
  scale_y_log10() +
  theme_classic() +
  geom_boxplot(width = 0.7, show.legend = F, data = LongData2 %>% filter(!is.na(TP.mg_L)), 
               aes(x=factor(plotYear), y=TP.mg_L, fill=factor(preLong)),
               outlier.size=0.5, lwd = 0.5) +
  scale_fill_manual(values=c("grey", "white")) +
  geom_line(data = newdat3, 
            aes(group = preLong, x = as.factor(plotYear), y = TP, 
                colour = as.factor(preLong)),
            show.legend = F,
            lwd = 1.2) +
  scale_color_manual(values=c(I("#DC3220"), I("black"))) +
  ylab("Total Phosphorus (mg/L)") +
  xlab("Years Relative to Alum Treatment") 


ggsave("LT_TP.pdf", path = here("Plots"))


ggplot() + 
  scale_y_log10() +
  theme_classic() +
  geom_boxplot(width = 0.7, show.legend = F, data = LongData2 %>% filter(!is.na(NP.ratio)), 
               aes(x=factor(plotYear), y=NP.ratio, fill=factor(preLong)),
               outlier.size=0.5, lwd = 0.5) +
  scale_fill_manual(values=c("grey", "white")) +
  geom_line(data = newdat3, 
            aes(group = preLong, x = as.factor(plotYear), y = NP, 
                colour = as.factor(preLong)),
            show.legend = F,
            lwd = 1.2) +
  scale_color_manual(values=c(I("#005AB5"), I("black"))) +
  ylab("TN:TP") +
  xlab("Years Relative to Alum Treatment") 

ggsave("LT_NP.pdf", path = here("Plots"))

my_y_title <- expression(paste("Chlorophyll ", italic("a"), " (ug/L)"))
ggplot() + 
  scale_y_log10() +
  theme_classic() +
  geom_boxplot(width = 0.7, show.legend = F, data = LongData2 %>% filter(!is.na(chla.ug_L)), 
               aes(x=factor(plotYear), y=chla.ug_L, fill=factor(preLong)),
               outlier.size=0.5, lwd = 0.5) +
  scale_fill_manual(values=c("grey", "white")) +
  geom_line(data = newdat3, 
            aes(group = preLong, x = as.factor(plotYear), y = chla, 
                colour = as.factor(preLong)),
            show.legend = F,
            lwd = 1.2) +
  scale_color_manual(values=c(I("#DC3220"), I("black"))) +
  ylab(my_y_title) +
  xlab("Years Relative to Alum Treatment") 

ggsave("LT_chla.pdf", path = here("Plots"))


ggplot() + 
  #scale_y_log10() +
  theme_classic() +
  geom_boxplot(width = 0.7, show.legend = F, data = LongData2 %>% filter(!is.na(secchi.m)), 
               aes(x=factor(plotYear), y=secchi.m, fill=factor(preLong)),
               outlier.size=0.5, lwd = 0.5) +
  scale_fill_manual(values=c("grey", "white")) +
  geom_line(data = newdat3, 
            aes(group = preLong, x = as.factor(plotYear), y = Secchi, 
                colour = as.factor(preLong)),
            show.legend = F,
            lwd = 1.2) +
  scale_color_manual(values=c(I("#005AB5"), I("#DC3220"))) +
  ylab("Secchi Depth (m)") +
  xlab("Years Relative to Alum Treatment") 

ggsave("LT_Secchi.pdf", path = here("Plots"))


```



-------------------------------------------
COMPARING CHANGE IN N AND P


linear models looking at how changes in TP and Secchi depth explain the change in TN, and how these relationships are moderated by lake depth

```{r, fig.width = 4, fig.height = 3}
PrePost_Summary <- PrePostData %>%
  filter(evertreat == 1) %>%
  group_by(DOWApp, treatment) %>%
  summarise(TP = mean(TP.mg_L, na.rm = T), TN = mean(N.mg_L, na.rm = T), Secchi = mean(secchi.m, na.rm=T)) %>%
  mutate(NP = (TN/TP) * (30.974/14.007)) %>%
  pivot_wider(names_from = treatment, values_from = c(TP, TN, NP, Secchi)) %>%
  mutate(TP_del = TP_post - TP_pre,
         TN_del = TN_post - TN_pre,
         NP_del = NP_post - NP_pre,
         TP_perc = (TP_del/TP_pre)*100,
         TN_perc = (TN_del/TN_pre)*100,
         NP_perc = (NP_del/NP_pre)*100,
         TP.delmol = TP_del/30.974,
         TN.delmol = TN_del/14.007,
         S_del = Secchi_post - Secchi_pre)


#add morphometry data
PrePost_Depth <- PrePost_Summary %>%
  mutate(DOW = substr(DOWApp, start = 1, stop = 8)) %>%
  left_join(., LakeList, by = "DOW") %>%
  mutate(Depth.Cat = factor(Depth.Cat, levels = c("Shallow","Deep"))) %>%
  mutate(TP.pre.mol = (TP_pre/30.974)*1000,
         TN.pre.mol = (TN_pre/14.007)*1000,
         TP.post.mol = (TP_post/30.974)*1000,
         TN.post.mol = (TN_post/14.007)*1000)

```


Percent change plots

```{r, fig.width=3, fig.height=3}
#percent change models and plots

TP.Litt.p <- lm(data = PrePost_Depth, TN_perc ~ TP_perc*Depth.Cat)
S.Litt.p <- lm(data = PrePost_Depth, TN_perc ~ S_del*Depth.Cat)
TP.S.Litt.p <- lm(data = PrePost_Depth, S_del ~ TP_perc*Depth.Cat)
summary(TP.Litt.p)
tidy(TP.Litt.p)
summary(S.Litt.p)
tidy(S.Litt.p)
summary(TP.S.Litt.p)
tidy(TP.S.Litt.p)

test(emtrends(TP.Litt.p, "Depth.Cat", var = "TP_perc"))
test(emtrends(S.Litt.p, "Depth.Cat", var = "S_del"))
test(emtrends(TP.S.Litt.p, "Depth.Cat", var = "TP_perc"))


ggplot(PrePost_Depth, aes(x = TP_perc, y = TN_perc, color = Depth.Cat, shape = Depth.Cat)) +
  scale_color_manual(values = c("#00BA38", "#619CFF")) +
  scale_shape_manual(values = c(17,19)) +
  geom_hline(yintercept = 0, lty = "dashed") +
  geom_vline(xintercept = 0, lty = "dashed") +
  geom_point(show.legend = F, cex = 2) +
  theme_classic() +
  geom_smooth(method = "lm", se = F, show.legend = F) +
  geom_point(data = PrePost_Depth %>% filter(DOWApp == "62000600a"), color = "black", shape = 1, cex = 4.25) +
  geom_point(data = PrePost_Depth %>% filter(DOWApp == "62005500a"), color = "#DC3220", shape = 1, cex = 4.25) +
  xlab("Percent Change in TP") + 
  ylab("Percent Change in TN")
ggsave("Litt_TN_TP.pdf", path = here("Plots"))

ggplot(PrePost_Depth, aes(x = S_del, y = TN_perc, color = Depth.Cat, shape = Depth.Cat)) +
  scale_color_manual(values = c("#00BA38", "#619CFF")) +
  scale_shape_manual(values = c(17,19)) +
  geom_hline(yintercept = 0, lty = "dashed") +
  geom_vline(xintercept = 0, lty = "dashed") +
  geom_point(show.legend = F, cex = 2) +
  theme_classic() +
  geom_smooth(method = "lm", se = F, show.legend = F) +
  geom_point(data = PrePost_Depth %>% filter(DOWApp == "62000600a"), color = "black", shape = 1, cex = 4.25) +
  geom_point(data = PrePost_Depth %>% filter(DOWApp == "62005500a"), color = "#DC3220", shape = 1, cex = 4.25) +
  xlab("Change in Secchi Depth (m)") + 
  ylab("Percent Change in TN")
ggsave("Litt_TN_Secchi.pdf", path = here("Plots"))

ggplot(PrePost_Depth, aes(y = S_del, x = TP_perc, color = Depth.Cat, shape = Depth.Cat)) +
  scale_color_manual(values = c("#00BA38", "#619CFF")) +
  scale_shape_manual(values = c(17,19)) +
  geom_hline(yintercept = 0, lty = "dashed") +
  geom_vline(xintercept = 0, lty = "dashed") +
  geom_point(show.legend = F, cex = 2) +
  theme_classic() +
  geom_smooth(method = "lm", se = F, show.legend = F) +
  geom_point(data = PrePost_Depth %>% filter(DOWApp == "62000600a"), color = "black", shape = 1, cex = 4.25) +
  geom_point(data = PrePost_Depth %>% filter(DOWApp == "62005500a"), color = "#DC3220", shape = 1, cex = 4.25) +
  ylab("Change in Secchi Depth (m)") + 
  xlab("Percent Change in TP")
ggsave("Litt_TP_Secchi.pdf", path = here("Plots"))
```

Stoichiometry plots and calculations

```{r, fig.width = 4, fig.height = 3}
           
#test the change in N:P
t.test(PrePost_Depth$NP_pre, PrePost_Depth$NP_post, paired = TRUE, alternative = "two.sided")
mean(PrePost_Depth$NP_pre)
mean(PrePost_Depth$NP_post)
sum(PrePost_Depth$NP_pre > 50)/46*100
sum(PrePost_Depth$NP_post > 50)/46*100

t.test(data = PrePost_Depth, NP_del ~ Depth.Cat, var.equal = T)


PrePost_WSr <- PrePost_WSr %>%
 mutate(TP.pre.mol = (TP_pre/30.974)*1000,
         TN.pre.mol = (TN_pre/14.007)*1000,
         TP.post.mol = (TP_post/30.974)*1000,
         TN.post.mol = (TN_post/14.007)*1000)

#plot with molar ratios
#a = c(0.001,0.01)
#b = c(0.02,0.2)
a = c(1,10)
b = c(20,200)
Hecky_low <- data.frame(a, b)

#c = c(0.0005,0.01)
#d = c(0.025,0.5)
c = c(0.5,10)
d = c(25,500)
Hecky_high <- data.frame(c, d)

# plot change in N:P with Hecky 50 and 20 stoich lines
ggplot(PrePost_Depth) + 
  coord_equal() +
  scale_y_log10() +
  scale_x_log10() +
  geom_line(data = Hecky_low, aes(x = a, y = b)) +
  geom_line(data = Hecky_high, aes(x = c, y = d))+
  geom_point(data = PrePost_Depth %>% filter(Depth.Cat == "Deep"), aes(x = TP.pre.mol, y = TN.pre.mol), 
             color = "#619CFF", shape = 21, show.legend = F) +
  geom_point(data = PrePost_Depth %>% filter(Depth.Cat == "Shallow"), aes(x = TP.pre.mol, y = TN.pre.mol), 
             color = "#00BA38", shape = 2, show.legend = F) +
  geom_point(data = PrePost_Depth %>% filter(Depth.Cat == "Deep"), aes(x = TP.post.mol, y = TN.post.mol), 
             color = "#619CFF", shape = 19, show.legend = F) +
  geom_point(data = PrePost_Depth %>% filter(Depth.Cat == "Shallow"), aes(x = TP.post.mol, y = TN.post.mol), 
             color = "#00BA38", shape = 17, show.legend = F) +
  theme_classic() +
   xlab("Total Phosphorus (umol/L)") + 
  ylab("Total Nitrogen (umol/L)")
ggsave("Stoich.pdf", path = here("Plots"))



```

Case study! Looking at Kohlman and Como plants

Como Point-Intercept Surveys

```{r}

#### Read in Data ####
Plants_CO <- read.csv(here("Data/Como_Macrophytes.csv"))

Plants_CO_fall <- Plants_CO %>%
  select(-lake_name, -algae, -lemna_minor, -latitude, -longitude, -spirodela_polyrrhiza) %>%
  mutate(SURVEY_START = as.Date(parse_date_time(SURVEY_START, orders = 'ymd')),
         potamogeton_crispus = as.numeric(potamogeton_crispus)) %>%
  mutate(Julian = yday(SURVEY_START), 
         Month = month(SURVEY_START), 
         Year = year(SURVEY_START))%>%
  filter(Month == 8 | Month == 9) %>%
mutate(VEG = select(., ceratophyllum_demersum:najas_guadalupensis) %>% rowSums(na.rm = TRUE),
       NO_VEG_FOUND = if_else(VEG == 0, 1, 0))

Plants_CO_perc <- Plants_CO_fall %>%
  group_by(SURVEY_START) %>%
  summarise(n = n(), VEG_all = sum(NO_VEG_FOUND == 0)) %>%
  mutate(perc.veg = VEG_all/n*100,
         Year = year(SURVEY_START))

```


Kohlman Point-Intercept Data

```{r}
#### Read in Data ####
Plants_KM <- read.csv(here("Data/Kohlman_Macrophytes.csv"))

Plants_KM_fall <- Plants_KM %>%
  select(-lake_name, -algae, -wolffia_sp, -unk_sp, -algae.1, -wolffia_columbiana, -lemna_minor,
         -lemna_trisulca, -spirodela_polyrrhiza, -spirodela_polyrrhiza.1, -no_veg_found, -latitude, -longitude,
         -substrate) %>%
  mutate(SURVEY_START = as.Date(parse_date_time(SURVEY_START, orders = 'ymd'))) %>%
  mutate(Julian = yday(SURVEY_START), 
         Month = month(SURVEY_START), 
         Year = year(SURVEY_START))%>%
  filter(Month == 8 | Month == 9) %>%
mutate(VEG = select(., ceratophyllum_demersum:potamogeton_sp.1) %>% rowSums(na.rm = TRUE),
       NO_VEG_FOUND = if_else(VEG == 0, 1, 0))

Plants_KM_perc <- Plants_KM_fall %>%
  group_by(SURVEY_START) %>%
  summarise(n = n(), VEG_all = sum(NO_VEG_FOUND == 0)) %>%
  mutate(perc.veg = VEG_all/n*100,
         sampleYear = year(SURVEY_START))

```


Combine WQ data with plant data

```{r, fig.height=6, fig.width=2.5}

CO_TKN_facet <- Timeseries %>%
  filter(parameter == "TKN.mg_L" & DOW == "62005500") %>%
  filter(sampleYear >= 2018 & sampleYear <= 2023) %>%
  select(sampleDate, sampleYear, parameter, result)
  
CO_TP_facet <- Timeseries %>%
  filter(parameter == "TP.mg_L" & DOW == "62005500") %>%
  filter(sampleYear >= 2018 & sampleYear <= 2023) %>%
  select(sampleDate, sampleYear, parameter, result)

CO_Secchi_facet <- Timeseries %>%
  filter(parameter == "secchi.m" & DOW == "62005500") %>%
  filter(sampleYear >= 2018 & sampleYear <= 2023) %>%
  select(sampleDate, sampleYear, parameter, result)

#CO_chla_facet <- Timeseries %>%
#  filter(parameter == "chla.Pcorr.ug_L" & DOW == "62005500") %>%
#  filter(sampleYear >= 2018 & sampleYear <= 2023) %>%
#  select(sampleDate, sampleYear, parameter, result)
  
CO_plant_facet <- Plants_CO_perc %>%
  rename(result = perc.veg, sampleYear = Year) %>%
  filter(sampleYear >= 2018) %>%
  select(-SURVEY_START, -n, -VEG_all) %>%
  mutate(sampleDate = NA,
         parameter = "plants")

CO_facet <- rbind(CO_TP_facet, CO_TKN_facet, CO_Secchi_facet, CO_plant_facet) %>%
  mutate(parameter = factor(parameter, c("TP.mg_L", "secchi.m", "TKN.mg_L", "plants"))) %>%
  mutate(y_max = case_when(parameter == "TKN.mg_L" ~ 3,
                            parameter == "TP.mg_L" ~ 0.3,
                           parameter == "secchi.m" ~ 3,
                           parameter == "plants" ~ 100)) %>%
   mutate(y_min = case_when(parameter == "TKN.mg_L" ~ 0,
                            parameter == "TP.mg_L" ~ 0,
                            parameter == "secchi.m" ~ 0))

ggplot(aes(x = sampleYear, y = result), data = CO_facet) +
  facet_wrap(~parameter, ncol = 1, scales = "free") +
  geom_boxplot(aes(group = as.factor(sampleYear), y = result), data = CO_facet %>% filter(parameter == "TP.mg_L")) +
  geom_boxplot(aes(group = as.factor(sampleYear), y = result), data = CO_facet %>% filter(parameter == "TKN.mg_L")) +
  geom_boxplot(aes(group = as.factor(sampleYear), y = result), data = CO_facet %>% filter(parameter == "secchi.m")) +
  expand_limits(y=0)+
  geom_col(data = CO_facet %>% filter(parameter == "plants"), width = 0.8, fill = "darkgreen")+
  theme_classic()+
  theme(strip.background = element_blank(),strip.text.x = element_blank(),
        panel.spacing.y = unit(1, "lines"),
        axis.text.x = element_blank(), axis.ticks.x = element_blank()) +
  ylab("") +
  geom_blank(aes(y = y_max)) +
  geom_blank(aes(y = y_min))

ggsave("Como_plants.pdf", path = here("Plots"))


```


```{r, fig.height=6, fig.width=2.5}
KM_TKN_facet <- Timeseries %>%
  filter(parameter == "TKN.mg_L" & DOW == "62000600") %>%
  filter(sampleYear >= 2008 & sampleYear <= 2013) %>%
  select(sampleDate, sampleYear, parameter, result)
  
KM_TP_facet <- Timeseries %>%
  filter(parameter == "TP.mg_L" & DOW == "62000600") %>%
  filter(sampleYear >= 2008 & sampleYear <= 2013) %>%
  select(sampleDate, sampleYear, parameter, result)

KM_Secchi_facet <- Timeseries %>%
  filter(parameter == "secchi.m" & DOW == "62000600") %>%
  filter(sampleYear >= 2008 & sampleYear <= 2013) %>%
  select(sampleDate, sampleYear, parameter, result)
  
KM_plant_facet <- Plants_KM_perc %>%
  rename(result = perc.veg) %>%
  filter(sampleYear >= 2008 & sampleYear <= 2013) %>%
  select(-SURVEY_START, -n, -VEG_all) %>%
  mutate(sampleDate = NA,
         parameter = "plants")

KM_facet <- rbind(KM_TP_facet, KM_TKN_facet, KM_Secchi_facet, KM_plant_facet) %>%
  mutate(parameter = factor(parameter, c("TP.mg_L","secchi.m", "TKN.mg_L", "plants"))) %>%
  mutate(y_max = case_when(parameter == "TKN.mg_L" ~ 3,
                            parameter == "TP.mg_L" ~ 0.3,
                           parameter == "secchi.m" ~ 3,
                           parameter == "plants" ~ 100)) %>%
  mutate(y_min = case_when(parameter == "TKN.mg_L" ~ 0,
                            parameter == "TP.mg_L" ~ 0,
                           parameter == "secchi.m" ~ 0))

ggplot(aes(x = sampleYear, y = result), data = KM_facet) +
  facet_wrap(~parameter, ncol = 1, scales = "free") +
  geom_boxplot(aes(group = as.factor(sampleYear), y = result), data = KM_facet %>% filter(parameter == "TP.mg_L")) +
  geom_boxplot(aes(group = as.factor(sampleYear), y = result), data = KM_facet %>% filter(parameter == "TKN.mg_L")) +
   geom_boxplot(aes(group = as.factor(sampleYear), y = result), data = KM_facet %>% filter(parameter == "secchi.m")) +
  expand_limits(y=0)+
  geom_col(data = KM_facet %>% filter(parameter == "plants"), width = 0.8, fill = "darkgreen")+
  theme_classic()+
  theme(strip.background = element_blank(),strip.text.x = element_blank(),
        panel.spacing.y = unit(1, "lines"),
        axis.text.x = element_blank(), axis.ticks.x = element_blank()) +
  ylab("") +
  geom_blank(aes(y = y_max)) +
  geom_blank(aes(y = y_min)) 
ggsave("Kohlman_plants.pdf", path = here("Plots"))


```


Notes on BACI lake selection:

Washington: code 82 with 1 alum lake

```{r}
Washington <- AlumTimeseries %>%
  filter(str_detect(DOW, "^82"))

Washington_option <- Washington %>%
  filter(DOW == "82010400" | DOW == "82010300" | DOW == "82010100" | DOW == "82011800") %>%
  filter(parameter == "TKN.mg_L") %>%
  group_by(DOW) %>%
  summarise(TP = mean(result))

#Let's use 82010100 for avg depth and amount of TP although the others two have good data coverage if needed


```

Ramsey: code 62 with 4 alum lakes

```{r}
Ramsey <- AlumTimeseries %>%
  filter(str_detect(DOW, "^62"))

Ramsey_options <- Ramsey %>%
  filter(DOW == "62006701" | DOW == "62006200" | DOW == "62005700" | DOW == "62008000" | DOW == "62002200") %>%
  filter(parameter == "TKN.mg_L") %>%
  group_by(DOW, sampleYear) %>%
  summarise(n = n())

#Let's use 62006701, 62006200, 62005700, 62002200

```

Scott: code 70 with 2 alum lakes

```{r}
Scott <- AlumTimeseries %>%
  filter(str_detect(DOW, "^70"))

Scott_options <- Scott %>%
  filter(DOW == "70002600" | DOW == "70005000" | DOW == "70005400" | DOW == "70006900" | DOW == "70007200" | DOW == "70009100" | DOW == "70009500") %>%
  filter(parameter == "TP.mg_L") %>%
  group_by(DOW) %>%
  summarise(average = mean(result))

#Let's use 70005000, 70009500

```

Carver: code 10 with 3 alum lakes

```{r}
Carver <- AlumTimeseries %>%
  filter(str_detect(DOW, "^10"))

Carver_options <- Carver %>%
  #filter(DOW == "70002600" | DOW == "70005000" | DOW == "70005400" | DOW == "70006900" | DOW == "70007200" | DOW == "70009100" | DOW == "70009500") %>%
  filter(parameter == "TKN.mg_L") %>%
  group_by(DOW, sampleYear) %>%
  #summarise(average = mean(result))
  summarise(n = n())

#Let's use 10000700, 10005900, 10004200, 10001800,

```

Hennepin: code 27 with 13 alum lakes

```{r}
Hennepin <- AlumTimeseries %>%
  filter(str_detect(DOW, "^27"))

Hennepin_options <- Hennepin %>%
  filter(parameter == "TP.mg_L") %>%
  group_by(DOW) %>%
  summarise(average = mean(result))
  #summarise(n = n())

#Selected 15 lakes, put into excel

```

Dakota: code 19 with 15 alum lakes

```{r}
Dakota <- AlumTimeseries %>%
  filter(str_detect(DOW, "^19"))

Dakota_options <- Dakota %>%
  filter(parameter == "TP.mg_L") %>%
  group_by(DOW) %>%
  summarise(average = mean(result))
  #summarise(n = n())

#Selected 15 lakes, put into excel

```

